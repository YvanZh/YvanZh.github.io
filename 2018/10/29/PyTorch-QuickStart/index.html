<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
    

    

    
<!-- Baidu Tongji -->
<script>var _hmt = _hmt || []</script>
<script async src="//hm.baidu.com/hm.js?c61262c25ca5d4ed66df331a31b5bf49"></script>
<!-- End Baidu Tongji -->




    <meta charset="utf-8">
    
    
    <meta name="baidu-site-verification" content="HnoV7q61W5">
    
    
    
    <title>PyTorch 快速入门 | YvanZh&#39;s Blog | Goketsu Monogatari</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="Deep Learning,PyTorch">
    <meta name="description" content="一只菜鸟的PyTorch笔记！">
<meta name="keywords" content="Deep Learning,PyTorch">
<meta property="og:type" content="article">
<meta property="og:title" content="PyTorch 快速入门">
<meta property="og:url" content="http://yvanzh.top/2018/10/29/PyTorch-QuickStart/index.html">
<meta property="og:site_name" content="YvanZh&#39;s Blog">
<meta property="og:description" content="一只菜鸟的PyTorch笔记！">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://raw.githubusercontent.com/YvanZh/BlogPic/master/img/007v1rTBgy1fxscc47kg8j31hc0zk4qp.jpg">
<meta property="og:updated_time" content="2019-06-28T13:50:57.498Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="PyTorch 快速入门">
<meta name="twitter:description" content="一只菜鸟的PyTorch笔记！">
<meta name="twitter:image" content="https://raw.githubusercontent.com/YvanZh/BlogPic/master/img/007v1rTBgy1fxscc47kg8j31hc0zk4qp.jpg">
    
        <link rel="alternate" type="application/atom+xml" title="YvanZh&#39;s Blog" href="/atom.xml">
    
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/style.css?v=1.7.2">
    <link href="/css/prism/prism-atom-dark.css" rel="stylesheet">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    


</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-list-ul"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/back_blue.png)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">YvanZh</h5>
          <a href="mailto:Yvan562220078@gmail.com" title="Yvan562220078@gmail.com" class="mail">Yvan562220078@gmail.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/">
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives">
                <i class="icon icon-lg icon-archives"></i>
                归档
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories">
                <i class="icon icon-lg icon-th-list"></i>
                分类
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags">
                <i class="icon icon-lg icon-tags"></i>
                标签
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/books">
                <i class="icon icon-lg icon-book"></i>
                读书
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/movies">
                <i class="icon icon-lg icon-film"></i>
                影视
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/games">
                <i class="icon icon-lg icon-gamepad"></i>
                游戏
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/music">
                <i class="icon icon-lg icon-music"></i>
                音乐
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/poetry">
                <i class="icon icon-lg icon-leaf"></i>
                诗意
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/cogito">
                <i class="icon icon-lg icon-lightbulb-o"></i>
                哲思
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/faraway">
                <i class="icon icon-lg icon-moon-o"></i>
                远方
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/about">
                <i class="icon icon-lg icon-info-circle"></i>
                关于
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">PyTorch 快速入门</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">PyTorch 快速入门</h1>
        <h5 class="subtitle">
            
                <time datetime="2018-10-29T04:01:33.000Z" itemprop="datePublished" class="page-time">
  2018-10-29
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/PyTorch/">PyTorch</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#1-前言"><span class="post-toc-text">1 前言</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#2-构建一个神经网络"><span class="post-toc-text">2 构建一个神经网络</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#2-1-网络结构"><span class="post-toc-text">2.1 网络结构</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#2-2-损失函数"><span class="post-toc-text">2.2 损失函数</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#2-3-优化器"><span class="post-toc-text">2.3 优化器</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#3-小试牛刀：CIFAR-10分类"><span class="post-toc-text">3 小试牛刀：CIFAR-10分类</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#3-1-数据处理"><span class="post-toc-text">3.1 数据处理</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#3-2-构建网络"><span class="post-toc-text">3.2 构建网络</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#3-3-训练网络"><span class="post-toc-text">3.3 训练网络</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#3-4-测试网络"><span class="post-toc-text">3.4 测试网络</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#3-5-GPU加速"><span class="post-toc-text">3.5 GPU加速</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#4-后记"><span class="post-toc-text">4 后记</span></a></li></ol>
        </nav>
    </aside>


<article id="post-PyTorch-QuickStart" class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">PyTorch 快速入门</h1>
        <div class="post-meta">
            <time class="post-time" title="2018-10-29 12:01:33" datetime="2018-10-29T04:01:33.000Z" itemprop="datePublished">2018-10-29</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/PyTorch/">PyTorch</a></li></ul>



            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style="display:none">
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


            
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <blockquote>
<p><strong><em>一只菜鸟的PyTorch笔记！</em></strong></p>
</blockquote>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://raw.githubusercontent.com/YvanZh/BlogPic/master/img/007v1rTBgy1fxscc47kg8j31hc0zk4qp.jpg" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>
<a id="more"></a>
<h1 id="1-前言"><a href="#1-前言" class="headerlink" title="1 前言"></a>1 前言</h1><p>如今主流的学习框架有两个。其一是Google推出的<code>TensorFlow</code>，其二是由Facebook推出的<code>PyTorch</code>。相较之下后者更容易上手，且其动态图的设计也十分利于了解和调节神经网络结构，这也是其异军突起的原因。</p>
<p>笔者建议使用<code>Jupyter Lab</code>来学习。因其即时交互和支持<code>Markdown</code>等优点，许多Tutorial都是用采用的<code>.ipynb</code>来记录的。初次学习需要对<code>Python</code>有基础的了解。此文参考的是<a href="https://pytorch.org/tutorials/beginner/blitz/neural_networks_tutorial.html#sphx-glr-beginner-blitz-neural-networks-tutorial-py" target="_blank" rel="noopener">PyTorch官方教程</a>。此外，多多查阅<a href="https://pytorch.org/docs/stable/index.html" target="_blank" rel="noopener">PyTorch官方文档</a>会让你更快地上手。</p>
<p>所依赖的环境如下：</p>
<ul>
<li>Python 3.6.6</li>
<li>PyTorch 0.4.1</li>
<li>TorchVision 0.2.1</li>
</ul>
<h1 id="2-构建一个神经网络"><a href="#2-构建一个神经网络" class="headerlink" title="2 构建一个神经网络"></a>2 构建一个神经网络</h1><p>构建一个神经网络的主要步骤为：</p>
<ol>
<li>定义网络结构。</li>
<li>定义损失函数。</li>
<li>定义优化器。</li>
</ol>
<h2 id="2-1-网络结构"><a href="#2-1-网络结构" class="headerlink" title="2.1 网络结构"></a>2.1 网络结构</h2><p>定义网络时，需要继承父类<code>nn.Module</code>，调用父类的初始化函数<code>__init__</code>，并实现它的<code>forward</code>函数，把网络中具有可学习参数的层放在初始化函数<code>__init__</code>中。如果某一层(如<code>ReLU</code>)不具有可学习的参数，则既可以放在初始化函数中，也可以不放，建议是不放在其中，而在<code>forward</code>中使用<code>nn.functional</code>代替。</p>
<p>只要在<code>nn.Module</code>的子类中定义了<code>forward</code>函数，<code>backward</code>函数就会自动被实现(利用<code>autograd</code>)。在<code>forward</code>函数中可使用任何<code>tensor</code>支持的函数，还可以使用<code>if</code>和<code>for</code>循环，<code>print</code>、<code>log</code>等<code>Python</code>语法，写法和标准的<code>Python</code>写法一致。</p>
<p>定义一个简单的卷积神经网络LeNet，如下：</p>
<pre><code class="lang-python">import torch
import torch.nn as nn
import torch.nn.functional as F

class Net(nn.Module): # 定义一个子类Net，并继承父类nn.module。
    def __init__(self): # 定义初始化方法__init__。
        super(Net, self).__init__() # 等价于nn.Module.__init__(self) 
                                    # 调用父类的初始化方法__init__。

        # 卷积层    
        self.conv1 = nn.Conv2d(1, 6, 5) # 输入通道为1，输出通道为6（即分别与六个滤波器做卷积），滤波器大小为5*5)
        self.conv2 = nn.Conv2d(6, 16, 5) # conv2d表示输入为二维的卷积层。注意：torch中不支持一维的卷积运算。

        # 全连接层/仿射层，y = Wx + b。
        self.fc1 = nn.Linear(16*5*5, 120) # 定义fc1（fullconnect）全连接函数1为线性函数：y = Wx + b，并将16*5*5个节点连接到120个节点上。
        self.fc2 = nn.Linear(120, 84)
        self.fc3 = nn.Linear(84, 10)

    def forward(self, x): # 定义前向传播。
        x = F.max_pool2d(F.relu(self.conv1(x)), (2, 2)) # 输入x经过卷积conv1之后，经过激活函数ReLU，使用2x2的窗口进行最大池化Max_pool2d，然后更新到x。
        x = F.max_pool2d(F.relu(self.conv2(x)), 2) # 输入x经过卷积conv2之后，经过激活函数ReLU，使用2*2的窗口进行最大池化Max_pool2d,然后更新到x。
        x = x.view(x.size()[0], -1) # view函数将池化后的[in_chanel,6,5,5]四维张量x,变形成根据in_chanel大小的[x.size()[0],-1]二维形式，其中-1表示自适应。总特征数并不改变，为接下来的全连接作准备。
        x = F.relu(self.fc1(x)) # 输入x经过全连接fc1后，经过激活函数ReLU更新到x。
        x = F.relu(self.fc2(x)) # 输入x经过全连接fc2后，经过激活函数ReLU更新到x。
        x = self.fc3(x) # 输入x经过全连接fc3后，更新到x。
        return x # 返回值x。

net = Net() # 创建一个Net的实例net。
print(net)

&quot;&quot;&quot;Out:
Net(
  (conv1): Conv2d(1, 6, kernel_size=(5, 5), stride=(1, 1))
  (conv2): Conv2d(6, 16, kernel_size=(5, 5), stride=(1, 1))
  (fc1): Linear(in_features=400, out_features=120, bias=True)
  (fc2): Linear(in_features=120, out_features=84, bias=True)
  (fc3): Linear(in_features=84, out_features=10, bias=True)
)
&quot;&quot;&quot;
</code></pre>
<p>网络的可学习参数通过<code>net.parameters()</code>返回：</p>
<pre><code class="lang-python">params = list(net.parameters())
print(len(params))

&quot;&quot;&quot;Out:
10
&quot;&quot;&quot;
</code></pre>
<p><code>net.named_parameters</code>可同时返回可学习的参数及名称：</p>
<pre><code class="lang-python">for name,parameters in net.named_parameters(): # 可将其看作字典
    print(name,&#39;:&#39;,parameters.size())

&quot;&quot;&quot;Out:
conv1.weight : torch.Size([6, 1, 5, 5])
conv1.bias : torch.Size([6])
conv2.weight : torch.Size([16, 6, 5, 5])
conv2.bias : torch.Size([16])
fc1.weight : torch.Size([120, 400])
fc1.bias : torch.Size([120])
fc2.weight : torch.Size([84, 120])
fc2.bias : torch.Size([84])
fc3.weight : torch.Size([10, 84])
fc3.bias : torch.Size([10])
&quot;&quot;&quot;
</code></pre>
<p>需要注意的是，<code>torch.nn</code>只支持<code>mini-batches</code>，不支持一次只输入一个样本，即一次必须是一个<code>batch</code>。但如果只想输入一个样本，则用<code>input.unsqueeze(0)</code>将<code>batch_size</code>设为1。例如<code>nn.Conv2d</code>输入必须是4维张量，形如$nSamples \times nChannels \times Height \times Width$。可将<code>nSample</code>设为1，即$1 \times nChannels \times Height \times Width$。</p>
<h2 id="2-2-损失函数"><a href="#2-2-损失函数" class="headerlink" title="2.2 损失函数"></a>2.2 损失函数</h2><p>输入和输出：</p>
<pre><code class="lang-python">input = torch.randn(1, 1, 32, 32) # 输入一个随机生成的样本。
out = net(input) # 输出
input.size(),out.size() #输入和输出的都是Tensor。

&quot;&quot;&quot;Out:
(torch.Size([1, 1, 32, 32]), torch.Size([1, 10]))
&quot;&quot;&quot;
</code></pre>
<p>前向传播，计算损失：</p>
<pre><code class="lang-python">output = net(input)
target = torch.randn(10)  # a dummy target, for example.随机生成一个目标，可理解为label值。
target = target.view(1, -1) # 转换为[1, n]的二维张量，-1表示自适应。
criterion = nn.MSELoss() # 定义均方误差损失函数。
loss = criterion(output, target)
loss # lost是个scalar

&quot;&quot;&quot;Out:
tensor(0.7358, grad_fn=&lt;MseLossBackward&gt;)
&quot;&quot;&quot;
</code></pre>
<p>反向传播，计算梯度：</p>
<pre><code class="lang-python">net.zero_grad() # 把net中所有可学习参数的梯度清零
print(&#39;反向传播之前 conv1.bias的梯度&#39;)
print(net.conv1.bias.grad)
loss.backward()
print(&#39;反向传播之后 conv1.bias的梯度&#39;)
print(net.conv1.bias.grad)

&quot;&quot;&quot;Out:
反向传播之前 conv1.bias的梯度
None
反向传播之后 conv1.bias的梯度
tensor([-0.0030, -0.0066, -0.0036,  0.0317,  0.0085,  0.0023])
&quot;&quot;&quot;
</code></pre>
<h2 id="2-3-优化器"><a href="#2-3-优化器" class="headerlink" title="2.3 优化器"></a>2.3 优化器</h2><p>在反向传播计算完所有参数的梯度后，还需要使用优化方法来更新网络的权重和参数，例如随机梯度下降法(SGD)的更新策略如下：</p>
<script type="math/tex; mode=display">Weight = Weight - LearningRate * Gradient</script><p>手动实现如下：</p>
<pre><code class="lang-python">learning_rate = 0.01
for f in net.parameters():
    f.data.sub_(f.grad.data * learning_rate) # inplace 减法
</code></pre>
<p><code>torch.optim</code>中实现了深度学习中绝大多数的优化方法，例如<code>RMSProp</code>、<code>Adam</code>、<code>SGD</code>等，更便于使用，因此大多数时候并不需要手动写上述代码。</p>
<p>调用优化器进行操作如下：</p>
<pre><code class="lang-python">import torch.optim as optim
#新建一个优化器，指定要调整的参数和学习率
optimizer = optim.SGD(net.parameters(), lr = 0.01)

# 在训练过程中
# 先梯度清零(与net.zero_grad()效果一样)
optimizer.zero_grad() 

# 前向传播，计算损失。
output = net(input)
loss = criterion(output, target)

#反向传播，计算梯度。
loss.backward()

#更新参数。
optimizer.step()
</code></pre>
<p>就这样这样反复迭代下去，直到收敛，即可得到最终的模型。之后便是测试过程了。</p>
<h1 id="3-小试牛刀：CIFAR-10分类"><a href="#3-小试牛刀：CIFAR-10分类" class="headerlink" title="3 小试牛刀：CIFAR-10分类"></a>3 小试牛刀：CIFAR-10分类</h1><p><a href="http://www.cs.toronto.edu/~kriz/cifar.html" target="_blank" rel="noopener">CIFAR-10</a>是一个常用的彩色图片数据集，它有10个类别: ‘airplane’, ‘automobile’, ‘bird’, ‘cat’, ‘deer’, ‘dog’, ‘frog’, ‘horse’, ‘ship’, ‘truck’。每张图片都是<code>3×32×32</code>，也即3-通道彩色图片，分辨率为32×32。 通过<a href="https://pan.baidu.com/s/1G4Eh5PyDHYnlrlcUDHtEfw" target="_blank" rel="noopener">百度网盘下载</a>到本地会更有效率。</p>
<p>实现对CIFAR-10分类的步骤如下：</p>
<ol>
<li>数据处理。</li>
<li>构建网络。   </li>
<li>训练网络。</li>
<li>测试网络。</li>
</ol>
<h2 id="3-1-数据处理"><a href="#3-1-数据处理" class="headerlink" title="3.1 数据处理"></a>3.1 数据处理</h2><p>加载并预处理CIFAR-10数据集，如下：</p>
<pre><code class="lang-python">import torch
import torchvision as tv
import torchvision.transforms as transforms
from torchvision.transforms import ToPILImage

# 第一次运行程序torchvision会自动下载CIFAR-10数据集。
# 大约163M，需花费一定的时间。
# 如果已经下载有CIFAR-10，可通过root参数指定。

# 定义对数据的预处理方式
transform = transforms.Compose([
        transforms.ToTensor(), # 把一个取值范围是[0,255]的PIL.Image或者shape为(H,W,C)的numpy.ndarray，转换成形状为[C,H,W]，取值范围是[0,1.0]的torch.FloadTensor。
        transforms.Normalize((0.5, 0.5, 0.5), (0.5, 0.5, 0.5)), # 归一化。Normalize(mean,std)：这里有三个通道，每个通道减去均值后除以标准差。
                             ])

# 训练集
trainset = tv.datasets.CIFAR10(
                    root = &#39;H:/Data/CIFAR-10/&#39;, 
                    train = True, 
                    download = True,
                    transform = transform)

#################参数说明#################
# root : cifar-10-batches-py 的根目录。
# train : True = 训练集； False = 测试集 。
# download :  True = 从互联上下载数据，并将其放在root目录下。如果数据集已经下载，什么都不干。
# transform : A function/transform = 将PIL(python image library) image进行转换。
# target_transform : A function/transform = 对target（即标签）进行转换。 
#########################################

trainloader = torch.utils.data.DataLoader(  #数据加载器。组合数据集和采样器，并在数据集上提供单进程或多进程迭代器。
                    trainset, 
                    batch_size = 4,
                    shuffle = True, 
                    num_workers = 2)

#################参数说明#################
# dataset (Dataset) – 加载数据的数据集。
# batch_size (int, optional) – 每个batch加载多少个样本。(默认: 1)
# shuffle (bool, optional) – 设置为True时会在每个epoch（整个训练集被遍历的次数）重新打乱数据。(默认: False)
# sampler (Sampler, optional) – 定义从数据集中提取样本的策略。如果指定，则忽略shuffle参数。
# num_workers (int, optional) – 用多少个子进程加载数据。0表示数据将在主进程中加载。(默认: 0)
# collate_fn (callable, optional) – 合并一个示例列表以形成一个Mini-batch。
# pin_memory (bool, optional) – 如果为True，数据加载器将把张量复制到CUDA固定内存中，然后返回它们。
# drop_last (bool, optional) – 如果数据集大小不能被batch size整除，则设置为True后可删除最后一个不完整的batch。如果设为False并且数据集的大小不能被batch size整除，则最后一个batch将更小。(默认: False)
#########################################

# 测试集
testset = tv.datasets.CIFAR10(
                    &#39;H:/Data/CIFAR-10/&#39;,
                    train = False, 
                    download = True, 
                    transform = transform)

testloader = torch.utils.data.DataLoader(
                    testset,
                    batch_size = 4, 
                    shuffle = False,
                    num_workers = 2)

classes = (&#39;plane&#39;, &#39;car&#39;, &#39;bird&#39;, &#39;cat&#39;,&#39;deer&#39;, &#39;dog&#39;, &#39;frog&#39;, &#39;horse&#39;, &#39;ship&#39;, &#39;truck&#39;) # classes是一个元组，对应dataset的标签。
</code></pre>
<ul>
<li><p>Dataset对象是一个数据集，可以按下标访问，返回形如(data, label)的数据。可尝试输出一张图片及其标签：</p>
<pre><code class="lang-python">  (data, label) = trainset[100]
  print(classes[label]) # 打印对应label的标签。

  show = ToPILImage() # 可以把Tensor转成PIL.Image，方便可视化
  show((data + 1) / 2).resize((100, 100)) # (data + 1) / 2是为了还原被归一化的数据。
</code></pre>
</li>
<li><p>Dataloader是一个可迭代的对象，它将dataset返回的每一条数据拼接成一个batch，并提供多线程加速优化和数据打乱等操作。当程序对dataset的所有数据遍历完一遍之后，相应的对Dataloader也完成了一次迭代。可尝试输出一个batch的图片及其标签：</p>
<pre><code class="lang-python">  dataiter = iter(trainloader) # 因trainloader的shuffle参数设置为True，所以每次迭代时每个batch的内容被打乱。
  images, labels = dataiter.next() # 返回4张图片及标签
  print(&#39; &#39;.join(&#39;%11s&#39;%classes[labels[j]] for j in range(4)))
  show(tv.utils.make_grid((images+1)/2)).resize((400,100))
</code></pre>
</li>
</ul>
<h2 id="3-2-构建网络"><a href="#3-2-构建网络" class="headerlink" title="3.2 构建网络"></a>3.2 构建网络</h2><p>拷贝前文中构建的LeNet网络，因CIFAR-10是3通道彩图，修改self.conv1第一个参数为3通道即可。</p>
<pre><code class="lang-python">import torch.nn as nn
import torch.nn.functional as F

class Net(nn.Module):
    def __init__(self):
        super(Net, self).__init__()
        self.conv1 = nn.Conv2d(3, 6, 5) 
        self.conv2 = nn.Conv2d(6, 16, 5)  
        self.fc1   = nn.Linear(16*5*5, 120)  
        self.fc2   = nn.Linear(120, 84)
        self.fc3   = nn.Linear(84, 10)

    def forward(self, x): 
        x = F.max_pool2d(F.relu(self.conv1(x)), (2, 2)) 
        x = F.max_pool2d(F.relu(self.conv2(x)), 2) 
        x = x.view(x.size()[0], -1) 
        x = F.relu(self.fc1(x))
        x = F.relu(self.fc2(x))
        x = self.fc3(x)        
        return x

net = Net()

use_cuda = False # 控制全局是否使用GPU。

if use_cuda: 
    net = net.cuda()

print(net)

# 损失函数和优化器。
from torch import optim
criterion = nn.CrossEntropyLoss() # 交叉熵损失函数
optimizer = optim.SGD(net.parameters(), lr=0.001, momentum=0.9) # 随机梯度下降优化器。        

############ 优化tricks之动量法参数momentum ############
# 一般，神经网络在更新权值时，采用公式为： w = w - learning_rate * dw
# 引入momentum后，采用公式为： w = momentum * w - learning_rate * dw
# 其在平坦的区域收敛会加快。
######################################################

&quot;&quot;&quot;Out:
Net(
  (conv1): Conv2d(3, 6, kernel_size=(5, 5), stride=(1, 1))
  (conv2): Conv2d(6, 16, kernel_size=(5, 5), stride=(1, 1))
  (fc1): Linear(in_features=400, out_features=120, bias=True)
  (fc2): Linear(in_features=120, out_features=84, bias=True)
  (fc3): Linear(in_features=84, out_features=10, bias=True)
)
&quot;&quot;&quot;
</code></pre>
<h2 id="3-3-训练网络"><a href="#3-3-训练网络" class="headerlink" title="3.3 训练网络"></a>3.3 训练网络</h2><p>使用处理好的数据分批训练：</p>
<pre><code class="lang-python">torch.set_num_threads(8) # 获得用于并行化CPU操作的OpenMP线程数
for epoch in range(2):  #训练两个epoch。即两次遍历训练集。

    running_loss = 0.0
    for i, data in enumerate(trainloader, 0):

        # 输入数据
        inputs, labels = data # 数据加载器生成的data为一个list，其包含两个元素，第一个是inputs值，第二个是labels值

        if use_cuda: # 是否使用GPU。
            inputs, labels = inputs.cuda(), labels.cuda()

        # 梯度清零
        optimizer.zero_grad()

        # forward + backward 
        outputs = net(inputs)
        loss = criterion(outputs, labels)
        loss.backward()   

        # 更新参数 
        optimizer.step()

        # 打印log信息
        # loss 是一个scalar,需要使用loss.item()来获取数值，不能使用loss[0]，否则返回的是一个tensor
        running_loss += loss.item()
        if i % 2000 == 1999: # 每2000个batch打印一下训练状态
            print(&#39;[%d, %5d] loss: %.3f&#39; % (epoch+1, i+1, running_loss / 2000)) # 每两千次训练的平均损失。
            running_loss = 0.0
print(&#39;Finished Training&#39;) 

&quot;&quot;&quot;Out:
[1,  2000] loss: 2.205
[1,  4000] loss: 1.810
[1,  6000] loss: 1.674
[1,  8000] loss: 1.564
[1, 10000] loss: 1.480
[1, 12000] loss: 1.469
[2,  2000] loss: 1.385
[2,  4000] loss: 1.365
[2,  6000] loss: 1.350
[2,  8000] loss: 1.289
[2, 10000] loss: 1.289
[2, 12000] loss: 1.270
Finished Training
&quot;&quot;&quot;
</code></pre>
<h2 id="3-4-测试网络"><a href="#3-4-测试网络" class="headerlink" title="3.4 测试网络"></a>3.4 测试网络</h2><p>首先尝试一个batch中四张图片：</p>
<pre><code class="lang-python">dataiter = iter(testloader)
images, labels = dataiter.next() # 一个batch返回4张图片
print(&#39;实际的label: &#39; &#39;\n&#39; , &#39; &#39;.join(&#39;%10s&#39; % classes[labels[j]] for j in range(4)))
if use_cuda: # 是否使用GPU。
    images, labels = images.cuda(), labels.cuda()    
show(tv.utils.make_grid((images.to(&#39;cpu&#39;)+1) / 2)).resize((400,100)) # 用.to(&#39;cpu&#39;)将cuda Tensor转换为普通的Tensor来画图

&quot;&quot;&quot;Out:
实际的label: 
        cat       ship       ship      plane
&quot;&quot;&quot;
</code></pre>
<p>然后查看测试结果：</p>
<pre><code class="lang-python"># 计算图片在每个类别上的分数
outputs = net(images)
# 得分最高的那个类
_, predicted = torch.max(outputs.data, 1) # torch.max(Tensor, dimension(optional))输出Tensor中指定维度最大值及其索引
print(&#39;预测结果: &#39; &#39;\n&#39;, &#39; &#39;.join(&#39;%10s&#39;% classes[predicted[j]] for j in range(4)))

&quot;&quot;&quot;Out:
预测结果: 
       frog        car       ship      plane
&quot;&quot;&quot;
</code></pre>
<p>计算全局准确率：</p>
<pre><code class="lang-python">correct = 0 # 预测正确的图片数
total = 0 # 总共的图片数

# 由于测试的时候不需要求导，可以暂时关闭autograd，提高速度，节约内存。
with torch.no_grad():
    for data in testloader:
        images, labels = data

        if use_cuda: # 是否使用GPU。
            images, labels = images.cuda(), labels.cuda()

        outputs = net(images)
        _, predicted = torch.max(outputs, 1) 
        total += labels.size(0)
        correct += (predicted == labels).sum() # (predicted == labels)是一个Tensor，为真时值为1，假时值为0。

print(&#39;10000张测试集中的准确率为: %d %%&#39; % (100 * correct / total))

&quot;&quot;&quot;Out:
10000张测试集中的准确率为: 55 %
&quot;&quot;&quot;
</code></pre>
<p>比随机猜测的准确率百分之十要好，说明算法是有效的。</p>
<h2 id="3-5-GPU加速"><a href="#3-5-GPU加速" class="headerlink" title="3.5 GPU加速"></a>3.5 GPU加速</h2><p>如使用GPU加速，则所需添加环境：</p>
<ul>
<li>CUDA Toolkit V9.0</li>
<li>cuDNN v7.3</li>
</ul>
<p>具体可参考笔者的<a href="http://yvanzh.top/2018/10/05/Win10&amp;TensorFlow-GPU/">前篇博文</a>。</p>
<p>在上述的代码中，只需设置<code>use_cuda = Ture</code>即可。如自行设置GPU加速,需注意：</p>
<pre><code class="lang-python">device = torch.device(&quot;cuda:0&quot; if torch.cuda.is_available() else &quot;cpu&quot;) # device命名。如果多个CPU有待补充，TODO。
net.to(device) # 将网络存入显存
inputs = inputs.to(device) # 将训练时的输入存入显存
labels = labels.to(device) # 将标签存入显存
images = images.to(device) # 将测试时的输入存入显存
</code></pre>
<h1 id="4-后记"><a href="#4-后记" class="headerlink" title="4 后记"></a>4 后记</h1><p>恭喜你已经初步掌握了<code>PyTorch</code>，之后便是独自修行的过程了。望诸位早日成为一名合格的“炼丹师”！</p>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2019-06-28T13:50:57.498Z" itemprop="dateUpdated">2019-06-28 21:50:57</time>
</span><br>


        
        文章发布地址：<a href="/2018/10/29/PyTorch-QuickStart/" target="_blank" rel="external">http://yvanzh.top/2018/10/29/PyTorch-QuickStart/</a>
        
    </div>
    
    <footer>
        <a href="http://yvanzh.top">
            <img src="/img/avatar.jpg" alt="YvanZh">
            YvanZh
        </a>
    </footer>
</blockquote>

        
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>



        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Deep-Learning/">Deep Learning</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PyTorch/">PyTorch</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://yvanzh.top/2018/10/29/PyTorch-QuickStart/&title=《PyTorch 快速入门》 — YvanZh's Blog&pic=http://yvanzh.top/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://yvanzh.top/2018/10/29/PyTorch-QuickStart/&title=《PyTorch 快速入门》 — YvanZh's Blog&source=
一只菜鸟的PyTorch笔记！


                
                    
                    ..." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://yvanzh.top/2018/10/29/PyTorch-QuickStart/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《PyTorch 快速入门》 — YvanZh's Blog&url=http://yvanzh.top/2018/10/29/PyTorch-QuickStart/&via=http://yvanzh.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://yvanzh.top/2018/10/29/PyTorch-QuickStart/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2018/11/04/Git-Handbook/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">Git 手册</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2018/10/05/Win10-TensorFlow-GPU/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">Win10 系统下配置 TensorFlow-GPU 环境</h4>
      </a>
    </div>
  
</nav>



    











    <!-- Valine Comments -->
    <div class="comments vcomment v" id="vcomments"></div>
    <!-- <div class="comment" id="comment"></div> -->
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script>
    <!-- <script src="//t1.aixinxi.net/o_1c3n4pim01nl3jg91b6l1kjtkvsa.js"></script> -->
    <!-- <script src="/js/Valine.min.js"></script> -->
    <!-- <script src="https://cdnjs.cat.net/ajax/libs/jquery/3.2.1/jquery.min.js"></script> -->
    <script src="//cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
    <!-- Valine Comments script -->
    <script>
        var GUEST_INFO = ['nick','mail','link'];
        var guest_info = 'nick,mail,link'.split(',').filter(function(item){
          return GUEST_INFO.indexOf(item) > -1
        });
        new Valine({
            av: AV,
            // el: '#comments',
            el: '#vcomments',
            emoticon_url: 'https://abelsu7.top/alu', //表情图片网址
            emoticon_list: ["赞一个.png","坐等.png","长草.png","阴暗.png","邪恶.png","小眼睛.png","想一想.png","献黄瓜.png","献花.png","喜极而泣.png","无语.png","无所谓.png","无奈.png","投降.png","深思.png","期待.png","狂汗.png","蜡烛.png","看不见.png","惊喜.png","击掌.png","欢呼.png","得意.png","不出所料.png","观察.png"],//表情图片文件名
            // notify: 'false' == 'false',
            // verify: 'false' == 'false',
            // notify: 'false',
            // verify: 'false',
            notify: false,
            verify: false,
            appId: "AhTK0SAX1OjJszPA4WWvRE26-gzGzoHsz",
            appKey: "WOSP1qSGoeO32U7LzRh78Fhj",
            avatar: "mp",
            placeholder: "Write a comment",
            guest_info: guest_info.length == 0 ? GUEST_INFO : guest_info,
            pageSize: "10"
        })
    </script>
    <!-- Valine Comments end -->











</article>

<div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        感谢支持！
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/img/wechat.jpg" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/wechat.jpg" data-alipay="/img/alipay.jpg">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-item switch">切换</span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style="display:none">
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style="display:none">
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


            <p>
                
                    <span>
                        <a href="/atom.xml" target="_blank" class="rss" title="rss">
                            <i class="icon icon-lg icon-rss"></i>
                        </a>
                    </span>
                    
                        <span>
                            博客内容遵循 <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a>
                        </span>
            </p>
    </div>
    <div class="bottom">
        <p>
            <span>
                YvanZh &copy;
                    
                        2018 -
                            
                                2019
            </span>
            <span>
                
                    <a href="http://www.miitbeian.gov.cn/" target="_blank">
                        暂无备案
                    </a>
                    <br>
                    
                        Power by
                        <a href="http://hexo.io/" target="_blank">Hexo</a> Theme
                        <a href="https://github.com/abelsu7/hexo-theme-indigo-plus" target="_blank">indigo plus</a>
                        <p>Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a></p>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>
<a href="javascript:;" id="gobottom" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-comments"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://yvanzh.top/2018/10/29/PyTorch-QuickStart/&title=《PyTorch 快速入门》 — YvanZh's Blog&pic=http://yvanzh.top/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://yvanzh.top/2018/10/29/PyTorch-QuickStart/&title=《PyTorch 快速入门》 — YvanZh's Blog&source=
一只菜鸟的PyTorch笔记！


                
                    
                    ..." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://yvanzh.top/2018/10/29/PyTorch-QuickStart/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《PyTorch 快速入门》 — YvanZh's Blog&url=http://yvanzh.top/2018/10/29/PyTorch-QuickStart/&via=http://yvanzh.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://yvanzh.top/2018/10/29/PyTorch-QuickStart/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACGUlEQVR42u3aMW7DMBAEQP//006bwlR2STmAyFFlKI7MUbEg7+71iq/3ryu5P3rC9efRndsuDAyMxzLel9douaNvrr+I618Z/iIGBsYBjDwik/9q/5rH8fA+BgYGxvLn62DNXx8GBgbGOiOJ6bltIgYGBkZyiG0Z3wjrG87iGBgYD2TkVff///yV/gYGBsajGO/yut6cte2EuTV8WBUGBsbWjDzg8tZmQl0PXAwMjJMZ64MXeVktZ0ebRQwMjK0ZyQ+3J8eV19S2GTAwMM5htI3GNi7nRi6WKogYGBibMtqAa4tic9FchCwGBsZ2jCTs5g6xcwHasjEwME5gtDHXRmde+s8DevgcDAyMTRnrDcX8CfnRt2VjYGCczJg7ZLYDE20bIBqzwMDA2I7RlszyIG4DfW68DAMDY29G2wBYX24e5XWjAgMDY1NGcVAst5L5xnHl6IuBgYExV2KbK/rnAV00BjAwMLZgrLQb21GJe8fIhodYDAyMAxj58MRKA6DdXNaBi4GBsTUjSbB84ixvM+RjFsM1Y2BgHMb4Ruy2A2fXS8fAwDiHsRKpc9+5q9D2oWqIgYGxKWMu7PJS3foQGAYGBkYboN8Ym0i2gBgYGBjtEleWci/ylXdWMTAwDmYk5f6cdH3/DzAGBgbG1DZxLnDzo/LS1hADA+OBjLtK+e22Mh/IwMDAOJkxNyTR3mk3lMnxFQMD4wDGDwrFQc/Y+UaHAAAAAElFTkSuQmCC" alt="微信分享二维码">
</div>




    <script src="//cdn.jsdelivr.net/npm/node-waves@0.7.6/src/js/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: true };


</script>

<script src="/js/main.min.js?v=1.7.2"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/js/search.min.js?v=1.7.2" async></script>



<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<script async src="//cdn.jsdelivr.net/npm/mathjax@2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<!-- <script async src="//cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script> -->
<!-- <script async src="//cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script> -->




<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<script src="/js/prism.js"></script>


    <script src="/js/cursor.js"></script>




</body>
</html>
